# NWT_CLM
This repoistory contains scripts that are necessary for running and analyzing data from CLM point simulations at Niwot Ridge, using Tvan Forcing data. 

## Niwot scripts workflow:

1. Clean L1 tvan data using `tvan_supplemental_cleaning.R`*
2. Use `flow.lter.clm.R` to generate netcdf forcings for the model.
3. Follow the instructions in `CLM_instructions.md` to run the model at Niwot Ridge
4. Run `flow.obs.R` to download and format observations for comparison with the model
5. Run `flow.sim.R` to format model output for comparisons with observations
6. Run `Obs_sim_com_plots.R` to create comparison plots between simulation and observations

*This script will be rendered obsolete once the Tvan data is available on AmeriFlux 

![NWT_CLM workflow overview](./images/Conceptual_diagram.png)



## How to run each script

### 1. `tvan_supplemental_cleaning.R`

This script cleans up Tvan L1 data that has been produced with the Niwot LTER `tvan_L1_preprocess.R` script from the Niwot LTER's repository. It is a temporary script meant to add a few extra cleaning steps to the L1 tvan data, until that data can be uploaded to AmeriFlux. The script reads in ReddyProc-ready data output by the `tvan_L1_preprocess.R` script, filters several problem spots, plots yearly comparisons between the filtered and unfiltered data, downloads Saddle Met data from EDI to fill in the gaps in air temperature after 2016, and writes out the data to two files called `tvan_[tower]_[start_timestamp]_to_[end_endtimestamp]_flux_P_reddyproc_supproc.txt`

#### Inputs
 1. ReddyProc-ready files from `tvan_L1_preprocess.R`; This script expects those files to have the following variables
  - `NEE` - Net ecosystem exchange (umolm-2s-1)
  - `LE` - Latent heat flux (Wm-2)
  - `H` - Sensible heat flux (Wm-2)
  - `Ustar` - friction velocity (ms-1)
  - `Tair` - Air temperature (degC)
  - `VPD` - Vapor pressure density (kPa)
  - `rH` - relative humidity (unitless fraction)
  - `U` - Wind speed (ms-1)
  - `P` - Atmospheric Pressure (kPa)
  - `Tsoil` - Soil temperature (degC)
  - `Year` - Year of measurement (MST)
  - `DoY` - Day of year of measurement (MST)
  - `Hour` - decimal hour of measurement (MST)
  
 2. Air temperatures taken from Saddle Met data from EDI. This is automatically downloaded from EDI. Since it is only meant to fill in the gap in air temperature at 2016, only gaps from 2016+ are filled with Saddle air temperature data. 
 
#### User Options
 - `makeplots` - should plots be made? (`TRUE` or `FALSE`)
 - `DirOutBase` - The output directory for the script. It is recommended but not required that this be the same directory that holds the Reddyproc-ready files produced by tvan_L1_preprocess.R
 - `tower` - the tower data be supplementally processed, options are "East", "West", or "Both". If "Both" the both towers will be processed at once.
 - `east_data_fp` - The location of the east tvan data filepath, use "", if `tower = "West"`
 - `west_data_fp` - The location of the west tvan data filepath, use "", if `tower = "East"`

#### Outputs
The script will create a directory called `supp_filtering` in the `DirOutBase` location and save the filtered data to that directory. A directory to hold the Saddle Met data will be created within this directory and if `makeplots = TRUE` it will also create a directory called `plots` within the `supp_filtering` directory to hold the yearly plots of each variable. 

File structure: 

```bash
<DirOutBase>
└── supp_filtering
    ├── Plots
    |   └── [variable]_yearly_plots
    ├── tvan_[tower]_[start_timestamp]_to_[end_endtimestamp]_flux_P_reddyproc_supproc.txt
    └── saddle_met_data

```

### 2. `flow.lter.clm.R`
The `flow.lter.clm.R` script generates atmospheric forcings for CLM from Niwot Ridge. It assembles the forcings with observational data from three sources. Daily precipitation data from the saddle that has been distributed into half-hourly data according to the method laid out in Wieder et al. 2017, half-hourly radiation data from the NR1 AmeriFlux tower, the rest of the forcings from the Tvan towers at Niwot.

| <span> |
| :--- |
| **NOTE:** For this script to work, the user must have an AmeriFlux username and account. |
| <span> |

#### Inputs
 1. Tvan data from the Niwot Ridge Tvan towers, either tower can be used, or both. If both are used, then one tower will be used to gap-fill the other. For the variables that are fed into the model, the two towers have good congruence. Right now, the user specifies the location the data generated by `supplemental_cleaning.R`, but eventually, the data will be on Ameriflux and the `download_amflx()` function can be used to download this data. 
 
 2. Saddle daily precipitation data, these are automatically downloaded from EDI. As are C1 precipitation data from USCRN. The C1 data are used to distribute the daily precipitation from the Saddle proportionally into 30-minute timesteps. 
 
 3. AmeriFlux NR1 tower radiation data, these are automatically downloaded and used to provide short and long-wave radiation data for the forcings. 


#### User Options
 - `makeplots` - should plots be made? (`TRUE` or `FALSE`)
 - `DirOutBase` - the base directory for output, tagged with time and date version
 - `DirDnld` - Directory to download precipitation and radidation data to
 - `getNewData` - flag to determine if a newer version of precip data be automatically downloaded if one is available.
 - `amf_usr` - AmeriFlux username; NOTE: you cannot download Ameriflux data without a valid username to create an account, visit the Ameriflux website: https://ameriflux.lbl.gov/ Please also read their data-use policy, by downloading their data you are agreeing to follow it. The policy can be found here: https://ameriflux.lbl.gov/data/data-policy/
 - `tower` - the Tvan tower that will be used for the forcings. Options are "East", "West", or "Both". If "Both" the one tower will be used to gapfill the other tower basetower provides which tower is the baseline that will be filled with the other tower. Currently the East tower record is more complete and has fewer gaps and errors, so it is being used as the basetower.
 - `basetower` - The tower that will be used as the default, any gaps, will be filled with the other tower if tower is set to "Both"; Options are: "East" or "West". Recommended default is "East"
 - `east_data_fp` - The location of the east tvan data filepath, use "", if tower = "West". This is the location of the East tower output from `supplemental_cleaning.R` 
 - `west_data_fp` - The location of the east tvan data filepath, use "", if tower = "East". This is the location of the West tower output from `supplemental_cleaning.R` 
 
Options currently under development:

- `simulated_runoff_fp` - A character string specifying the location of the simulated runoff data from a moist meadow simulation to be added to Wet meadow precipitation. 

#### Outputs

**The `data` folder**

 - Five folders containing netcdf files for each of the precipitation regimes for the 4 vegetation communities, plus a folder with netcdf files of unaltered precipitation ("original") are produced. 
 - 3 text files are also produced:
   - `tvan_forcing_data_[tower]_[start_date]_[end_date].txt` - The ungapfilled data (prior to ReddyProc gapfilling); if `tower = "Both"` then this will be the data after both towers have been combined. 
   - `tvan_forcing_data_flagged_both_towers_[start_date]_[end_date].txt` - Flags indicating where data from one tower has been used to gap-fill another tower if `tower = "Both"`
   - `tvan_forcing_data_[tower]_[start_date]_[end_date].txt` - The fully gap-filled (with ReddyProc dataset including a precipitation column for each vegetation community's modified precipitation value)
   
**The `plots` folder**

 - `yearly_gap_plots_[year].png` - yearly plots showing gaps in the data prior to gap-filling of any kind
 - `all_years_gap_plots.png` - Plots showing gaps in the data prior to gap-filling for the whole period of forcing data.
 - `[start_date]_[end_date]_required_forcings_postgapfilling.png` - plots showing gaps in data after gap-filling for the whole period of forcing data
 - `[year]_yearly_gap_plots_postgapfilling.png` - yearly plots showing any gaps in the data after gap-filling is complete. 

**Directory structure:**

```bash
<DirOutBase>
└── <data_version>
    ├── data
    │   ├── tvan_forcing_data_both_towers_2007-05-11_2020-08-11.txt
    │   ├── tvan_forcing_data_flagged_both_towers_2007-05-11_2020-08-11.txt
    │   ├── tvan_forcing_data_precip_mods_both_towers_2007-05-11_2020-08-11.txt
    │   ├── dry_meadow
    │   │   ├── 2007-05.nc
    |   |   ....
    │   │   └── 2020-08.nc
    │   ├── fell_field
    │   │   ├── 2007-05.nc
    |   |   ....
    │   │   └── 2020-08.nc
    │   ├── moist_meadow
    │   │   ├── 2007-05.nc
    |   |   ....
    │   │   └── 2020-08.nc
    │   ├── original
    │   │   ├── 2007-05.nc
    |   |   ....
    │   │   └── 2020-08.nc
    │   ├── snow_bed
    │   │   ├── 2007-05.nc
    |   |   ....
    │   │   └── 2020-08.nc
    │   └── wet_meadow
    │       ├── 2007-05.nc
    |       ....
    │       └── 2020-08.nc
    └── plots
        ├── 2007-05-11_2020-08-10_required_forcing_postgapfilling.png
        ├── 2007_yearly_gap_plots_postgapfilling.png
        ....
        ├── 2020_yearly_gap_plots_postgapfilling.png
        ├── all_years_gap_plots.png
        ├── yearly_gap_plots_2007.png
        ....
        └── yearly_gap_plots_2020.png

```

### 3. `flow.obs.R`
Workflow for collating NIWOT LTER data in preparation to compare observations to simulated data. The purpose of this script is to read in observational data from Niwot, and summarize it by three time-levels: Diurnal by season, daily (day of year), and annually.

#### Inputs
 - Saddle senor network data from EDI (EDI ID: 210)
 - Saddle grid snow-depth data from EDI (EDI ID: 31)
 - Saddle productivity data from EDI (EDI ID: 16)
 - Saddle sensor network vegetation surveys from EDI (EDI ID: 191)
 - Tvan soil moisture and soil temperature data for fell-field vegetation runs
 - Tvan fluxes - from gap-filled data that was used to create netcdfs; to compare to modelled forcings 
 
 
#### User Options
 - `ver` - the data version, be default, the current system date and times
 - `DirOutBase` - the base location of the output data
 - `DirDnld` - Directory to download observation data to
 - `getNewData` - option to download the newest version of EDI data if one is available. Options: `TRUE` or `FALSE`
 - `tvan_data_fp` - Location of the tvan data that was used to create forcing files; this should be the "precip_mods" text file generated by `flow.lter.clm.R`. It must be ReddyProc-processed data because GPP is taken from this dataset. 
 - `tvan_data_soil` - Location of tvan data with soil information; This is the "Ameriflux-ready" version of the tvan data; Eventually it will need to be replaced with downloading the AmeriFlux Tvan data, once that data has been uploaded to AmeriFlux. Note: Tvan soil temperature data probes from East tower do not work, so please give west tower tvan data location


#### Outputs
This script outputs three files, the Diurnal-seasonal, daily, and yearly summaries of the observations. 

 - Diurnal-seasonal data: averaged by hour of the day across years by season. Includes mean and standard deviations of: NetRadiation (radNet), Sensible heat flux (H), Latent heat flux (LE), gross primary production (GPP)
 - Daily Data: Daily (day-of-year) means and standard deviations of soil moisture, soil temperature, and GPP; Daily snow depth at each plot.
 - Annual data: Annual means and standard deviations of production and biomass data

### 4. `flow.sim.R`
The goal of this script is to read in netcdf output data from a CLM model simulation and convert it into tab-delimited files that can be compared to observational data. The data produced is half-hourly but is also summarized at three levels: Diurnal by season, daily (day of year), and annually. Depending on the vegetation community that is specified by the user, a different level of soil will be used for the upper layer of soil moisture and soil temperature data. This is because Tvan soil data is collected at 10cm while the saddle sensor network soil data is collected at 5cm. 

#### Inputs
 - A netcdf file from a transient CLM point simulation at Niwot Ridge (following instructions in `CLM_instructions.md`); The netcdf should have a descriptive name (this is the name that will be used for the output). The netcdf file should be half-hourly output and at a minimum contain the following history fields:
 
 | Field Name  | Description                                                | Units    |
 | ----------- | ---------------------------------------------------------- | -------- |
 | FSH         | sensible heat flux                                         | W/m^2    |
 | T10         | temperature at 2m                                          | degC     |
 | RNET        | net radiation FSA-FIRA                                     | W/m^2    |
 | TSOI_2      | Soil temperature | 2nd layer; 4cm, 2-6cm layer)            | degC     |
 | TSOI_3      | Soil temperature (3rd layer; 9cm, 6-12cm layer)            | degC     |
 | TSOI_5      | Soil temperature (5th layer; 26cm, 20-32cm layer)          | degC     |
 | H2OSOI_2    | volumetric soil moisture (2nd layer; 4cm, 2-6cm layer)     | mm/mm    |
 | H2OSOI_3    | volumetric soil moisture (3rd layer; 9cm, 6-12cm layer)    | mm/mm    |
 | H2OSOI_5    | volumetric soil moisture ( 5th layer; 26cm, 20-32cm layer) | mm/mm    |
 | SNOW_DEPTH  | snow height of snow covered area                           | cm       |
 | EFLX_LH_TOT | total latent heat flux [+ to atm]                          | W/m^2    |
 | GPP         | Gross primary production                                   | gC/m^2/s |
 | AGNPP       | Aboveground net primary productivity                       | gC/m^2/s |
 | NPP         | Net primary production                                     | gC/m^2/s |
 
#### User Options

 - `DirOutBase` - Base directory for script output
 - `DirIn` - The input directory where simulation data is located
 - `ncdf_fp` - The name of the netcdf file from the simulation you want to work with
 - `veg_com`  The vegetation community of the simulation. Options: "FF", "DM", "WM", "MM", "SB", NA; This will determine which layer of soil moisture is used. 

#### Outputs

A folder in the base output directory named after the netcdf file basename with:
 1. Diurnal-seasonal data: all chosen variables averaged by hour of the day across years by season
 2. Daily Data: Daily (day-of-year) means and standard deviations of all chosen variables.
 3. Annual data: Annual means and standard deviations of all variables
 4. Unsummarized data: all chosen variables at all timestamps during the simulation
 5. Unit definitions: Units for each of the variables that are written out.

### 5. `Obs_sim_com_plots.R`

A script that creates plots comparing observation and simulation data after the style of Wieder et al. 2017

#### Input

 - The output from `flow.sim.R`
 - The output from `flow.obs.R`

#### User Options

 - `DirOutBase` - the output directory for the script
 - `sim_name` - the simulation name (for organizing output and naming outputs)
 - `DirSimIn` - the netcdf-named subdirectory containing the outputs from `flow.sim.R`
 - `DirObsIn` - the version-named subdirectory containing the outputs from `flow.obs.R`
 - `vegetation_com` - the vegetation community that is being compared. Options: "FF", "DM", "WM", "MM", "SB", NA;
 

#### Outputs

3 plots comparing the fluxes, soil moisture data, and snow-depth data from the simulation to observations. 
